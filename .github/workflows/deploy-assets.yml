name: Deploy Assets Branch

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Generate assets
        run: |
          npm -v >/dev/null 2>&1 || true
          sudo apt-get update -y
          sudo apt-get install -y poppler-utils
          node scripts/generate_covers.js
      - name: Prepare assets directory
        run: |
          rm -rf out-assets
          mkdir -p out-assets/images
          cp -r images/. out-assets/images/ || true
          cp docs/catalog.json out-assets/
      - name: Push to site-assets branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd out-assets
          git init
          git config user.email "actions@github.com"
          git config user.name "github-actions"
          git add .
          git commit -m "chore(assets): update images and catalog.json [skip ci]"
          git branch -M site-assets
          git remote add origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git
          git push -f origin site-assets